<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Valorant Tactical Coach — MVP</title>
    <style>
      :root {
        --bg: #0b0f16;
        --card: #121827;
        --accent: #7c3aed;
        --accent-2: #06b6d4;
        --ok: #10b981;
        --warn: #ef4444;
        --text: #e5e7eb;
        --muted: #9ca3af;
      }
      body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Segoe UI', sans-serif; background: linear-gradient(180deg, #0b0f16 0%, #0b0f16 60%, #0e1420 100%); color: var(--text); }
      header { padding: 16px 24px; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; align-items: center; }
      .brand { font-weight: 700; letter-spacing: 0.5px; }
      .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
      .grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; }
      .panel { background: linear-gradient(180deg, #0f172a 0%, #0b1120 100%); border: 1px solid #111827; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); }
      .panel h2 { margin: 0; padding: 16px; font-size: 16px; letter-spacing: 0.5px; border-bottom: 1px solid #111827; background: linear-gradient(180deg, #111827 0%, #0b1120 100%); }
      .panel .content { padding: 16px; }
      .toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      select, input[type="text"], input[type="number"] { background: #0b1220; border: 1px solid #1f2937; color: var(--text); padding: 8px 10px; border-radius: 8px; }
      button { background: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%); color: white; border: 0; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 6px 20px rgba(6,182,212,0.16); }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 12px; }
      .card { background: var(--card); border: 1px solid #111827; border-radius: 10px; padding: 12px; }
      .metric { font-size: 22px; font-weight: 700; }
      .muted { color: var(--muted); font-size: 12px; }
      .advice-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
      .advice-item { padding: 10px 12px; border-radius: 8px; border: 1px solid #111827; background: #0c1324; }
      .priority-high { border-left: 4px solid var(--warn); }
      .priority-medium { border-left: 4px solid #f59e0b; }
      .priority-low { border-left: 4px solid var(--ok); }
      .mapframe { position: relative; height: 360px; border-radius: 12px; overflow: hidden; border: 1px solid #111827; background: radial-gradient(circle at 30% 30%, #0b1a2a, #08111b 60%); }
      .mapframe .label { position: absolute; top: 8px; left: 10px; font-weight: 700; color: var(--muted); }
      canvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; }
      .toast { display:none; position: fixed; top: 0; left: 0; right: 0; background: #7f1d1d; color: #fecaca; padding: 10px 14px; font-weight: 600; text-align: center; z-index: 1000; }
      .sideform { display: grid; gap: 8px; }
      .row { display:flex; gap: 8px; }
      .row > * { flex: 1; }
      @media (max-width: 960px) { .grid { grid-template-columns: 1fr; } .cards { grid-template-columns: repeat(2, 1fr); } }
    </style>
  </head>
  <body>
    <div id="toast" class="toast">Network error. Please try again.</div>
    <header>
      <div class="brand">Valorant Tactical Coach — MVP</div>
      <div class="toolbar">
        <label>
          <span class="muted">Personality</span>
          <select id="personalitySelect">
            <option value="analyst">Analyst</option>
            <option value="strict">Strict</option>
            <option value="chill">Chill</option>
          </select>
        </label>
        <button id="getAdviceBtn">Get Advice</button>
      </div>
    </header>
    <main class="container">
      <div class="grid">
        <section class="panel">
          <h2>Match Board</h2>
          <div class="content">
            <div class="cards">
              <div class="card">
                <div class="muted">Win Rate</div>
                <div class="metric" id="metricWinRate">—</div>
              </div>
              <div class="card">
                <div class="muted">K/D</div>
                <div class="metric" id="metricKD">—</div>
              </div>
              <div class="card">
                <div class="muted">First Duel</div>
                <div class="metric" id="metricFDR">—</div>
              </div>
              <div class="card">
                <div class="muted">Rank</div>
                <div class="metric" id="metricRank">—</div>
              </div>
            </div>

            <div style="height: 16px"></div>

            <div class="mapframe">
              <div class="label" id="heatmapLabel">Heatmap — Ascent (demo)</div>
              <canvas id="heatmapCanvas"></canvas>
            </div>

            <div style="height: 16px"></div>

            <h3 style="margin:0 0 8px 0">Tactical Advice</h3>
            <ul id="tipsList" class="advice-list"></ul>

            <h3 style="margin:16px 0 8px 0">Loadout</h3>
            <div id="loadoutText" class="card">—</div>
          </div>
        </section>

        <aside class="panel">
          <h2>Inputs</h2>
          <div class="content">
            <div class="sideform">
              <div class="row">
                <label>Map
                  <select id="mapName"><option>Loading...</option></select>
                </label>
                <label>Agent
                  <select id="agent"><option>Loading...</option></select>
                </label>
              </div>
              <div class="row">
                <label>Econ
                  <select id="econ">
                    <option>full</option>
                    <option>force</option>
                    <option>eco</option>
                  </select>
                </label>
                <label>Favorite Weapon
                  <select id="favoriteWeapon"><option>Loading...</option></select>
                </label>
              </div>
              <div class="row">
                <label>K/D/A
                  <input id="kda" type="text" value="16/14/3" />
                </label>
                <label>Abilities Used %
                  <input id="abilitiesPct" type="number" value="55" />
                </label>
              </div>
              <div class="row">
                <label>First Duels Taken
                  <input id="fdt" type="number" value="11" />
                </label>
                <label>First Duels Won
                  <input id="fdw" type="number" value="4" />
                </label>
              </div>
              <div class="row">
                <label>Deaths While Entrying
                  <input id="entryDeaths" type="number" value="6" />
                </label>
              </div>
              <!-- Removed less-actionable inputs (plants, defuses, rounds) to simplify the form -->
            </div>
          </div>
        </aside>
      </div>
    </main>

    <script>
      const $$ = (id) => document.getElementById(id);
      const toast = $$('toast');
      function showError(msg) { toast.textContent = msg || 'Network error.'; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', 3000); }

      function renderMetrics(m) {
        $$('metricWinRate').textContent = m && typeof m.win_rate === 'number' ? Math.round(m.win_rate * 100) + '%' : '—';
        $$('metricKD').textContent = m && typeof m.kd_ratio === 'number' ? m.kd_ratio.toFixed(2) : '—';
        $$('metricFDR').textContent = m && typeof m.first_duel_rate === 'number' ? Math.round(m.first_duel_rate * 100) + '%' : '—';
        $$('metricRank').textContent = m && m.rank ? m.rank : '—';
      }

      function renderTips(tips) {
        const ul = $$('tipsList');
        ul.innerHTML = '';
        (tips || []).forEach(t => {
          const li = document.createElement('li');
          li.className = `advice-item priority-${t.priority || 'low'}`;
          li.textContent = t.message || '';
          ul.appendChild(li);
        });
      }

      function renderLoadout(txt) { $$('loadoutText').textContent = txt || '—'; }

      function drawHeatmap(canvas, hotspots) {
        const rect = canvas.getBoundingClientRect();
        const w = canvas.width = Math.max(1, rect.width);
        const h = canvas.height = Math.max(1, rect.height);
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,w,h);
        (hotspots || []).forEach(hs => {
          const x = (hs.x || 0) * w;
          const y = (hs.y || 0) * h;
          const r = 30 * (0.8 + (hs.intensity || 0));
          const g = ctx.createRadialGradient(x, y, 0, x, y, r);
          g.addColorStop(0, 'rgba(236,72,153,0.9)');
          g.addColorStop(1, 'rgba(236,72,153,0)');
          ctx.fillStyle = g;
          ctx.beginPath();
          ctx.arc(x, y, r, 0, Math.PI * 2);
          ctx.fill();
        });
      }

      async function loadHeatmap() {
        try {
          const map = $$('mapName').value || 'Ascent';
          const res = await fetch('/heatmap/demo?map=' + encodeURIComponent(map));
          if (!res.ok) throw new Error('heatmap failed');
          const data = await res.json();
          drawHeatmap($$('heatmapCanvas'), data.hotspots || []);
        } catch (e) {
          showError('Failed to load heatmap');
        }
      }

      async function loadMetrics() {
        try {
          const res = await fetch('/metrics/demo');
          if (!res.ok) throw new Error('metrics failed');
          renderMetrics(await res.json());
        } catch (e) {
          showError('Failed to load metrics');
        }
      }

      function payloadFromInputs() {
        return {
          map_name: $$('mapName').value,
          agent: $$('agent').value,
          econ: $$('econ').value,
          kda: $$('kda').value,
          first_duels_taken: Number($$('fdt').value),
          first_duels_won: Number($$('fdw').value),
          abilities_used_pct: Number($$('abilitiesPct').value),
          deaths_while_entrying: Number($$('entryDeaths').value),
          favorite_weapon: $$('favoriteWeapon').value,
          // rounds_played removed to simplify input set
          personality: $$('personalitySelect').value,
        };
      }

      async function onGetAdvice() {
        const btn = $$('getAdviceBtn');
        btn.disabled = true;
        try {
          const res = await fetch('/coach', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payloadFromInputs())
          });
          if (!res.ok) throw new Error('coach failed');
          const data = await res.json();
          renderTips(data.tips || []);
          renderLoadout(data.loadout_reco || '');
          renderMetrics(data.metrics || {});
        } catch (e) {
          showError('Failed to fetch advice');
        } finally { btn.disabled = false; }
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadMetrics();
        // Load options (maps / agents / weapons) from a central JSON file and populate selects
        async function loadOptions() {
          try {
            const res = await fetch('/web/options.json');
            if (!res.ok) throw new Error('options load failed');
            const opts = await res.json();

            const mapSel = $$('mapName');
            mapSel.innerHTML = '';
            (opts.maps || []).forEach(m => {
              const o = document.createElement('option'); o.textContent = m; o.value = m; mapSel.appendChild(o);
            });

            const agentSel = $$('agent');
            agentSel.innerHTML = '';
            const agents = opts.agents || {};
            Object.keys(agents).forEach(group => {
              const og = document.createElement('optgroup'); og.label = group;
              (agents[group] || []).forEach(a => { const o = document.createElement('option'); o.textContent = a; o.value = a; og.appendChild(o); });
              agentSel.appendChild(og);
            });

            const wSel = $$('favoriteWeapon');
            wSel.innerHTML = '';
            const weapons = opts.weapons || {};
            Object.keys(weapons).forEach(group => {
              const og = document.createElement('optgroup'); og.label = group;
              (weapons[group] || []).forEach(w => { const o = document.createElement('option'); o.textContent = w; o.value = w; og.appendChild(o); });
              wSel.appendChild(og);
            });

            // set initial heatmap label and load
            $$('heatmapLabel').textContent = 'Heatmap — ' + $$('mapName').value + ' (demo)';
            loadHeatmap();
          } catch (e) {
            // fallback to current hardcoded/default values in case options.json can't be fetched
            $$('heatmapLabel').textContent = 'Heatmap — ' + $$('mapName').value + ' (demo)';
            loadHeatmap();
          }
        }

        loadOptions();
        $$('mapName').addEventListener('change', () => { $$('heatmapLabel').textContent = 'Heatmap — ' + $$('mapName').value + ' (demo)'; loadHeatmap(); });
        $$('getAdviceBtn').addEventListener('click', onGetAdvice);
        // Warm up API for tests (they'll request JSON with Accept header)
        fetch('/', { headers: { 'Accept': 'application/json' } }).catch(() => {});
      });
    </script>
  </body>
  </html>
